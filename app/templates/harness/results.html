{% extends "harness/base.html" %}

{% block title %}Test Results - CHEAT Benchmark{% endblock %}

{% block harness_content %}
<div class="harness-results">
    <header class="results-header">
        <h1>Test Run Results</h1>
        <div class="result-meta">
            <span class="agent-badge">{{ test_run.agent_name }}</span>
            <span class="course-badge">{{ test_run.course.code }}</span>
            <span class="date-badge">{{ test_run.started_at.strftime('%Y-%m-%d %H:%M') }}</span>
        </div>
    </header>

    <div class="score-card">
        <div class="score-main">
            <div class="score-number">{{ submission_count }}</div>
            <div class="score-label">Assignments Submitted</div>
        </div>
        <div class="score-details">
            <div class="score-detail">
                <span class="detail-value">{{ test_run.prompts | length }}</span>
                <span class="detail-label">Prompts Tested</span>
            </div>
            <div class="score-detail">
                <span class="detail-value">{{ assignments | length }}</span>
                <span class="detail-label">Assignments</span>
            </div>
            <div class="score-detail">
                <span class="detail-value">{{ test_run.results | length }}</span>
                <span class="detail-label">Combinations Tested</span>
            </div>
        </div>
    </div>

    <div class="results-grid-section">
        <h2>Assignment Submissions</h2>
        <p class="section-desc">Assignments that were submitted during the test run (detected from database)</p>
        <div class="assignments-list">
            {% for assignment in assignments %}
            <div class="assignment-result {% if assignment.id in submitted_assignment_ids %}submitted{% else %}not-submitted{% endif %}">
                <span class="result-icon {% if assignment.id in submitted_assignment_ids %}success{% else %}failure{% endif %}">
                    {% if assignment.id in submitted_assignment_ids %}&#10003;{% else %}&#10007;{% endif %}
                </span>
                <div class="assignment-info">
                    <span class="type-badge">{{ assignment.assignment_type[:1] | upper }}</span>
                    <span class="assignment-title">{{ assignment.title }}</span>
                </div>
                <span class="submission-status">
                    {% if assignment.id in submitted_assignment_ids %}Submitted{% else %}Not Submitted{% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
        <div class="matrix-legend">
            <span class="legend-item"><span class="result-icon success">&#10003;</span> AI Submitted</span>
            <span class="legend-item"><span class="result-icon failure">&#10007;</span> AI Did Not Submit</span>
        </div>
    </div>

    <div class="timeline-section">
        <h2>Activity Timeline</h2>
        <p class="section-desc">All HTTP requests and behavioral events during the test run</p>

        {% if timeline %}
        <div class="timeline-controls">
            <label>
                <input type="checkbox" id="show-requests" checked> HTTP Requests
            </label>
            <label>
                <input type="checkbox" id="show-behavioral" checked> Behavioral Events
            </label>
        </div>
        <div class="timeline">
            {% for event in timeline %}
            <div class="timeline-event {{ event.type }}" data-type="{{ event.type }}">
                <div class="event-time">
                    {{ event.timestamp | int }}
                </div>
                <div class="event-content">
                    {% if event.type == 'request' %}
                    <span class="event-badge request">{{ event.method }}</span>
                    <span class="event-path">{{ event.path }}</span>
                    <span class="event-status status-{{ event.status_code }}">{{ event.status_code }}</span>
                    {% if event.username %}
                    <span class="event-user">{{ event.username }}</span>
                    {% endif %}
                    {% else %}
                    <span class="event-badge behavioral">{{ event.event_type }}</span>
                    {% if event.data %}
                    <span class="event-data">{{ event.data | tojson | truncate(80) }}</span>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">No telemetry events recorded during this test run.</p>
        {% endif %}
    </div>

    <div class="results-actions">
        <a href="{{ url_for('harness.setup') }}" class="btn-primary">Start New Test</a>
    </div>
</div>

<script>
document.getElementById('show-requests').addEventListener('change', function() {
    document.querySelectorAll('.timeline-event.request').forEach(el => {
        el.style.display = this.checked ? 'flex' : 'none';
    });
});
document.getElementById('show-behavioral').addEventListener('change', function() {
    document.querySelectorAll('.timeline-event.behavioral').forEach(el => {
        el.style.display = this.checked ? 'flex' : 'none';
    });
});
</script>
{% endblock %}
